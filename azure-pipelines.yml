# Disable CI and PR triggers properly
trigger: none
pr: none

resources:
  repositories:
    - repository: self

pool:
  vmImage: windows-latest

parameters:
- name: SubscriptionName
  displayName: subscription
  type: string
  default: "ME-MngEnvMCAP074743-jaiyeoribe-1"

- name: environment
  displayName: crims environment
  type: string
  default: "nonprod"
  values:
  - nonprod
  - prod

- name: location
  displayName: location
  type: string
  default: "canadacentral"

- name: mt_resource_group
  displayName: mt_resource_group
  type: string
  default: "rg-test"

# For nonprod, supply a comma-separated string of VMs
- name: mt_vm_names
  displayName: mt_vm_names (comma-separated for nonprod)
  type: string
  default: "i02609d1crnw002,i02609d2crnw002"

# For prod, generate from prefix/count/startcount
- name: prod_mt_vm_name_prefix
  displayName: prod_mt_vm_name_prefix
  type: string
  default: "i02609d1crnw"

- name: prod_mt_resource_group
  displayName: prod_mt_resource_group
  type: string
  default: "rg-test-prod"

- name: prod_mt_vm_count
  displayName: prod_mt_vm_count
  type: number
  default: 2

- name: prod_mt_vm_startcount
  displayName: prod_mt_vm_startcount
  type: number
  default: 2


stages:
- stage: INITIALSETUP
  displayName: INITIAL SETUP
  jobs:
  - job: BuildJob
    displayName: 'Compute VM list and output variables'
    steps:
    # If you don't want to checkout the repo, keep this as none
    - checkout: none

    - task: PowerShell@2
      name: SetVms
      displayName: Compute VM list
      inputs:
        targetType: 'inline'
        # Use | for multiline script; avoid HTML-escaped characters
        script: |
          Write-Host "Environment: ${{ parameters.environment }}"
          Write-Host "Location:    ${{ parameters.location }}"
          Write-Host "Sub:         ${{ parameters.SubscriptionName }}"

          # region Compute VM list
          if ("${{ parameters.environment }}" -eq "prod") {
            $vmPrefix   = "${{ parameters.prod_mt_vm_name_prefix }}".Trim()
            $count      = [int]"${{ parameters.prod_mt_vm_count }}"
            $startcount = [int]"${{ parameters.prod_mt_vm_startcount }}"

            if ([string]::IsNullOrWhiteSpace($vmPrefix)) {
              throw "prod_mt_vm_name_prefix cannot be empty for prod."
            }
            if ($count -le 0) {
              throw "prod_mt_vm_count must be > 0."
            }

            $vmNames = @()
            for ($i = 0; $i -lt $count; $i++) {
              $vmNumber = $startcount + $i
              # Format with 3 digits (e.g., 002, 003)
              $vmName = "{0}{1:D3}" -f $vmPrefix, $vmNumber
              $vmNames += $vmName
            }
            $vmList = $vmNames -join ","
            Write-Host "Generated PROD VM Names: $vmList"

            # resource group for prod
            $rgName = "${{ parameters.prod_mt_resource_group }}"
          }
          else {
            # Nonprod: use the provided comma-separated list, normalized
            $raw = "${{ parameters.mt_vm_names }}"
            $arr = $raw -split "," | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }

            if ($arr.Count -eq 0) {
              throw "mt_vm_names must contain at least one VM name for nonprod."
            }

            $vmList = $arr -join ","
            Write-Host "Using NONPROD VM Names: $vmList"

            # resource group for nonprod
            $rgName = "${{ parameters.mt_resource_group }}"
          }
          # endregion

          # Emit output variables for downstream jobs/stages
          Write-Host "##vso[task.setvariable variable=mt_vm_names;isOutput=true]$vmList"
          Write-Host "##vso[task.setvariable variable=resource_group;isOutput=true]$rgName"

  # ---------------------------------------------------------------------------
  # (Optional) Example consumer job showing how to read the outputs
  # Uncomment to test consumption of outputs
  #
  # - job: ConsumeOutputs
  #   displayName: 'Consume VM list outputs'
  #   dependsOn: BuildJob
  #   variables:
  #     VM_LIST: $[ dependencies.BuildJob.outputs['SetVms.mt_vm_names'] ]
  #     RG_NAME: $[ dependencies.BuildJob.outputs['SetVms.resource_group'] ]
  #   steps:
  #   - powershell: |
  #       Write-Host "From previous job - VM_LIST: $(VM_LIST)"
  #       Write-Host "From previous job - RG_NAME: $(RG_NAME)"
  #     displayName: 'Show outputs'
  # ---------------------------------------------------------------------------
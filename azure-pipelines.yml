# Azure DevOps pipeline: Resource Group 'what-if' with Bicep
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - modules/**
      - main.bicep
      - main.*.bicepparam
      - pipelines/azurepipelines-*.yml
    exclude:
      - pipelines/azurepipelines-integrationtests-cd.yml

pool:
  name: 'ubuntu-vm'

variables:
  # Global defaults (override per stage if needed)
  templateFile: 'main.bicep'

stages:
- stage: deve
  displayName: Development
  variables:
    subscription: 'sc-2511170040007559'   # <-- ADO service connection name (update to your exact name)
    resourceGroup: 'rg-2511170040007559'
    parameterFile: 'main.deve.bicepparam'
  jobs:
  - deployment: whatif
    displayName: Bicep What-If (RG)
    environment:
      name: 'contentplatform-development'   # optional; used for approvals/traceability
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            persistCredentials: false

          - task: AzureCLI@2
            displayName: Azure CLI Version Check
            inputs:
              azureSubscription: sc-2511170040007559
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(System.DefaultWorkingDirectory)
              inlineScript: |
                set -euo pipefail
                echo "Checking Azure CLI and Bicep..."
                az --version
                # Optional sanity check; if it fails, we still can deploy because az supports bicep files.
                az bicep version || echo "az bicep not listed; Azure CLI will still process .bicep via built-in support."

          - task: AzureCLI@2
            displayName: az deployment validate
            inputs:
              azureSubscription: sc-2511170040007559   # ADO Service Connection (classic or workload identity)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(System.DefaultWorkingDirectory)
              failOnStandardError: true
              inlineScript: |
                set -euo pipefail
                RG="$(resourceGroup)"
                TEMPLATE="$(templateFile)"
                PARAMS="$(parameterFile)"

                echo "Running what-if against resource group: ${RG}"
                echo "Template: ${TEMPLATE}"
                echo "Parameters: ${PARAMS}"

                az deployment group what-if \
                  --resource-group "${RG}" \
                  --template-file "${TEMPLATE}" \
                  --parameters "${PARAMS}" \
                  --mode Incremental \
                  --verbose